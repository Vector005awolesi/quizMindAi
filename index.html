<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMind AI | Local PDF Quizzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .drag-over { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <nav class="p-6 flex justify-between items-center max-w-6xl mx-auto" data-aos="fade-down">
        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">QuizMind AI</h1>
        <div id="model-status" class="text-xs font-medium px-3 py-1 rounded-full bg-gray-200 text-gray-600 transition-all duration-300">
            Initializing AI...
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4">
        
        <section id="input-section" class="space-y-6" data-aos="fade-up">
            <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100">
                <div class="flex border-b mb-6">
                    <button onclick="switchTab('pdf')" id="tab-pdf" class="pb-2 px-4 border-b-2 border-blue-500 font-semibold text-blue-600">PDF Upload</button>
                    <button onclick="switchTab('text')" id="tab-text" class="pb-2 px-4 border-b-2 border-transparent text-gray-400">Manual Text</button>
                </div>

                <div id="pdf-input" class="space-y-4">
                    <div id="drop-zone" class="border-2 border-dashed border-gray-200 rounded-2xl p-10 text-center hover:border-blue-400 transition-all cursor-pointer">
                        <i data-lucide="file-up" class="mx-auto mb-4 text-blue-500" size="48"></i>
                        <p id="file-name-display" class="text-gray-600 font-medium">Click to upload or drag and drop your PDF</p>
                        <input type="file" id="file-upload" class="hidden" accept=".pdf">
                    </div>
                </div>

                <div id="manual-input" class="hidden space-y-4">
                    <textarea id="text-area" rows="8" class="w-full p-4 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Paste your study notes here..."></textarea>
                </div>

                <button id="generate-btn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl transition-all shadow-lg flex justify-center items-center gap-2">
                    <i data-lucide="sparkles"></i> Generate AI Quiz
                </button>
            </div>
        </section>

        <section id="loading-section" class="hidden py-20 text-center">
            <div class="loader w-16 h-16 border-4 border-gray-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-2xl font-semibold text-gray-800">Processing Content...</h2>
            <p class="text-gray-500 mt-2">Extracting text and drafting questions.</p>
        </section>

        <section id="quiz-section" class="hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <div id="timer" class="bg-blue-50 text-blue-700 px-4 py-2 rounded-full font-mono font-bold">00:00</div>
                <div class="text-gray-500 font-medium">Question <span id="progress-text">1/5</span></div>
            </div>

            <div id="quiz-container"></div>

            <div class="flex justify-between pt-6">
                <button id="prev-btn" class="px-6 py-2 rounded-xl border border-gray-300 text-gray-600 disabled:opacity-30">Back</button>
                <div class="flex gap-2">
                    <button id="next-btn" class="px-8 py-2 rounded-xl bg-blue-600 text-white font-bold">Next</button>
                    <button id="submit-btn" class="hidden px-8 py-2 rounded-xl bg-green-600 text-white font-bold">Finish Quiz</button>
                </div>
            </div>
        </section>

        <section id="result-section" class="hidden">
            <div class="bg-white p-10 rounded-3xl shadow-2xl text-center">
                <div class="w-24 h-24 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto mb-6 text-2xl font-bold" id="final-score">0%</div>
                <h2 class="text-3xl font-bold mb-8">Results</h2>
                <div id="review-container" class="text-left space-y-4"></div>
                <button onclick="window.location.reload()" class="mt-8 w-full py-4 bg-gray-100 rounded-2xl font-bold">New Quiz</button>
            </div>
        </section>
    </main>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';
        
        env.allowLocalModels = false;
        let generator;
        let quizData = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let selectedFile = null;

        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- 1. Sarter AI Loading ---
        async function initAI() {
            const status = document.getElementById('model-status');
            try {
                generator = await pipeline('text2text-generation', 'Xenova/flan-t5-small', {
                    progress_callback: (data) => {
                        if (data.status === 'initiate') {
                            status.innerText = "Checking Cache...";
                            status.className = "text-xs px-3 py-1 rounded-full bg-yellow-100 text-yellow-700";
                        } else if (data.status === 'download') {
                            status.innerText = `Downloading AI: ${Math.round(data.progress)}%`;
                            status.className = "text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-600";
                        } else if (data.status === 'done') {
                            status.innerText = "AI Ready";
                            status.className = "text-xs px-3 py-1 rounded-full bg-green-100 text-green-600";
                        }
                    }
                });
            } catch (err) {
                status.innerText = "Error loading AI";
            }
        }
        initAI();

        // --- 2. File Upload Fixes ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name-display');

        dropZone.onclick = () => fileInput.click();

        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFile(e.dataTransfer.files[0]);
        };

        function handleFile(file) {
            if (file && file.type === "application/pdf") {
                selectedFile = file;
                fileNameDisplay.innerText = `Selected: ${file.name}`;
                fileNameDisplay.classList.add('text-blue-600');
            } else {
                alert("Please select a valid PDF file.");
            }
        }

        // --- 3. Text Extraction & Generation ---
        async function extractText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(" ");
            }
            return text;
        }

        document.getElementById('generate-btn').onclick = async () => {
            let contextText = document.getElementById('text-area').value;
            
            if (!contextText && selectedFile) {
                document.getElementById('input-section').classList.add('hidden');
                document.getElementById('loading-section').classList.remove('hidden');
                contextText = await extractText(selectedFile);
            } else if (!contextText) {
                alert("Upload a PDF or paste text first!");
                return;
            } else {
                document.getElementById('input-section').classList.add('hidden');
                document.getElementById('loading-section').classList.remove('hidden');
            }

            // Slice text to avoid context overflow for small model
            const chunks = contextText.split(/[.!?]/).filter(s => s.trim().length > 40).slice(0, 5);
            
            quizData = [];
            for (let chunk of chunks) {
                const out = await generator(`generate a question: ${chunk}`, { max_new_tokens: 40 });
                quizData.push({
                    question: out[0].generated_text,
                    answer: chunk.trim()
                });
            }

            showQuiz();
        };

        // --- 4. Quiz Logic ---
        function showQuiz() {
            document.getElementById('loading-section').classList.add('hidden');
            document.getElementById('quiz-section').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            const q = quizData[currentQuestionIndex];
            document.getElementById('progress-text').innerText = `${currentQuestionIndex + 1}/${quizData.length}`;
            document.getElementById('quiz-container').innerHTML = `
                <div class="bg-white p-8 rounded-3xl shadow-lg animate-in fade-in duration-500">
                    <h2 class="text-2xl font-bold mb-6">${q.question}</h2>
                    <input type="text" id="ans-input" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="Your answer..." value="${userAnswers[currentQuestionIndex] || ''}">
                </div>
            `;
            
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            if (currentQuestionIndex === quizData.length - 1) {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('submit-btn').classList.remove('hidden');
            } else {
                document.getElementById('next-btn').classList.remove('hidden');
                document.getElementById('submit-btn').classList.add('hidden');
            }
        }

        document.getElementById('next-btn').onclick = () => {
            userAnswers[currentQuestionIndex] = document.getElementById('ans-input').value;
            currentQuestionIndex++;
            renderQuestion();
        };

        document.getElementById('prev-btn').onclick = () => {
            userAnswers[currentQuestionIndex] = document.getElementById('ans-input').value;
            currentQuestionIndex--;
            renderQuestion();
        };

        document.getElementById('submit-btn').onclick = () => {
            userAnswers[currentQuestionIndex] = document.getElementById('ans-input').value;
            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            
            const review = document.getElementById('review-container');
            let correct = 0;
            quizData.forEach((q, i) => {
                const isCorrect = (userAnswers[i] || "").length > 3; // Basic check
                if (isCorrect) correct++;
                review.innerHTML += `
                    <div class="p-4 rounded-xl ${isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                        <p class="font-bold">${q.question}</p>
                        <p class="text-sm text-gray-600 mt-2">Source: ${q.answer.substring(0, 100)}...</p>
                    </div>
                `;
            });
            document.getElementById('final-score').innerText = `${Math.round((correct/quizData.length)*100)}%`;
        };

        window.switchTab = (type) => {
            document.getElementById('pdf-input').classList.toggle('hidden', type !== 'pdf');
            document.getElementById('manual-input').classList.toggle('hidden', type !== 'text');
            document.getElementById('tab-pdf').className = type === 'pdf' ? 'pb-2 px-4 border-b-2 border-blue-500 font-semibold text-blue-600' : 'pb-2 px-4 text-gray-400';
            document.getElementById('tab-text').className = type === 'text' ? 'pb-2 px-4 border-b-2 border-blue-500 font-semibold text-blue-600' : 'pb-2 px-4 text-gray-400';
        };

        AOS.init();
        lucide.createIcons();
    </script>
</body>
</html>
